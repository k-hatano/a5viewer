<html>

<head>
	<title>
		a5viewer
	</title>
	<script>
		var reader = new FileReader();
		var entities = new Array();
		var relations = new Array();
		var pages = new Array();

		var xRate = 2;
		var yRate = 2;

		var scrollX = 0;
		var scrollY = 0;
		var origX = 0;
		var origY = 0;
		var dragging = false;

		onload = function() {
			var canvasEr = document.getElementById('canvas_er');
			canvasEr.onmousedown = function(e) {
				erMouseDown(e);
			};
			canvasEr.onmousemout = function(e) {
				erMouseOut(e);
			};
			canvasEr.onmouseup = function(e) {
				erMouseUp(e);
			};
			canvasEr.onmousemove = function(e) {
				erMouseMove(e);
			};
		}

		function drawER() {
			var canvasEr = document.getElementById('canvas_er');
			var width = canvasEr.width;
			var height = canvasEr.height;

			var maxWidth = 0;
			var maxHeight = 0;

			var ctx = canvasEr.getContext('2d');

			var viewLevel = document.getElementById("view_level").value;

			ctx.lineWidth = 0.5;
			ctx.clearRect(0, 0, width, height);

			var page = document.getElementById('page').value;

			for (var i in entities) {
				var entity = entities[i];

				if (entity.page != page) {
					continue;
				}

				var left = parseInt(entity.x, 10) / xRate;
				var top = parseInt(entity.y, 10) / yRate;
				var right = parseInt(entity.nameWidth, 10);
				var bottom = top + (entity.fields.length * 16);
				if (viewLevel == 1) {
					right = parseInt(entity.nameWidth, 10) + parseInt(entity.keyWidth, 10);
				} else if (viewLevel == 2) {
					right = parseInt(entity.nameWidth, 10) + parseInt(entity.typeWidth, 10);
				} 
				ctx.clearRect(left-4 + scrollX, top+4 + scrollY, right +12, bottom-top+4);

				var offset = parseInt(entity.nameWidth, 10);

				ctx.fillText(entity.name, left + scrollX, top + scrollY);
				for (var j in entity.fields) {
					ctx.fillText(entity.fields[j].name, left + scrollX, top + (parseInt(j)+1) * 16 + scrollY);
				}

				if (viewLevel == 1) {
					ctx.fillText(entity.key, left + offset + 4 + scrollX, top + scrollY);
					for (var j in entity.fields) {
						ctx.fillText(entity.fields[j].key, left + offset + 4 + scrollX, top + (parseInt(j)+1) * 16 + scrollY);
					}
				} else if (viewLevel == 2) {
					for (var j in entity.fields) {
						ctx.fillText(entity.fields[j].type, left + offset + 4 + scrollX, top + (parseInt(j)+1) * 16 + scrollY);
					}

				}

				entities[i].left = parseInt(left-4);
				entities[i].top = parseInt(top+4);
				entities[i].width = parseInt(right +12);
				entities[i].height = parseInt(bottom-top+4);
				entities[i].right = parseInt(entities[i].left + entities[i].width);
				entities[i].bottom = parseInt(entities[i].top + entities[i].height);

				// ctx.clearRect(left-4, top+4, 128+12, bottom-top+8);
				ctx.strokeRect(entities[i].left + scrollX, entities[i].top + scrollY, entities[i].width, entities[i].height);

				if (maxWidth < entities[i].right) {
					maxWidth = entities[i].right;
				}

				if (maxHeight < entities[i].bottom) {
					maxHeight = entities[i].bottom;
				}
			}

			for (var i in relations) {
				var relation = relations[i];

				if (relation.page != page) {
					continue;
				}

				var left = parseInt(relation.x, 10) / xRate;
				var top = parseInt(relation.y, 10) / yRate;
				var top2 = parseInt(relation.z, 10) / yRate;
				var entity1 = relation.entity1;
				var entity2 = relation.entity2;

				var objEntity1 = undefined;
				for (var j in entities) {
					if (entity1 == entities[j].key) {
						objEntity1 = entities[j];
					}
				} 
				var objEntity2 = undefined;
				for (var j in entities) {
					if (entity2 == entities[j].key) {
						objEntity2 = entities[j];
					}
				} 

				if (objEntity1.left > objEntity2.right) {
					var objEntity3 = objEntity2;
					objEntity2 = objEntity1;
					objEntity1 = objEntity3;
				}

				if (objEntity1.top > objEntity2.bottom) {
					var objEntity3 = objEntity2;
					objEntity2 = objEntity1;
					objEntity1 = objEntity3;
				}

				if (objEntity1.right < objEntity2.left) {
					var x1 = objEntity1.right;
					var y1 = (objEntity1.top + objEntity1.bottom) / 2;
					var x2 = (objEntity1.right + objEntity2.left) / 2;
					var y2 = (objEntity1.top + objEntity1.bottom) / 2;
					var x3 = (objEntity1.right + objEntity2.left) / 2;
					var y3 = (objEntity2.top + objEntity2.bottom) / 2;
					var x4 = objEntity2.left;
					var y4 = (objEntity2.top + objEntity2.bottom) / 2;
				} else {
					var x1 = (objEntity1.right + objEntity1.left) / 2;
					var y1 = objEntity1.bottom;
					var x2 = (objEntity1.right + objEntity1.left) / 2;
					var y2 = (objEntity2.top + objEntity1.bottom) / 2;
					var x3 = (objEntity2.right + objEntity2.left) / 2;
					var y3 = (objEntity2.top + objEntity1.bottom) / 2;
					var x4 = (objEntity2.right + objEntity2.left) / 2;
					var y4 = objEntity2.top
				}

				ctx.beginPath();
				ctx.moveTo(x1 + scrollX, y1 + scrollY);
				ctx.lineTo(x2 + scrollX, y2 + scrollY);
				ctx.lineTo(x3 + scrollX, y3 + scrollY);
				ctx.lineTo(x4 + scrollX, y4 + scrollY);
				ctx.stroke();
			}
		}

		function loadER() {
			var myFile = document.getElementById("input_a5er").files[0];

			reader.onload = function(evt){
				var canvasEr = document.getElementById('canvas_er');
				var width = canvasEr.width;
				var height = canvasEr.height;

				var ctx = canvasEr.getContext('2d');

				var txt = evt.target.result;
				var txtArr = txt.split(/\r\n|\r|\n/);
				txtArr.reverse();

				entities = new Array();
				relations = new Array();
				pages = new Array();

				var entity = new Array();
				var relation = new Array();
				var fields = new Array();
				for (var line in txtArr) {
					if (txtArr[line].match(/^Position=\"(.*)\",(\d+),(\d+)/)) {
						relation.page = RegExp.$1;
						entity.page = RegExp.$1;
						entity.x = RegExp.$2;
						entity.y = RegExp.$3;
						if (pages.indexOf(entity.page) < 0) {
							pages.push(entity.page);
						}
					} else if (txtArr[line].match(/^Field=\"(.*?)\",\"(.*?)\",\"(.*?)\"/)) {
						var field = { name: RegExp.$1, key: RegExp.$2, type: RegExp.$3 };
						var nameWidth = ctx.measureText(RegExp.$1).width;
						if (entity.nameWidth == undefined) {
							entity.nameWidth = nameWidth;
						} else if (entity.nameWidth < nameWidth) {
							entity.nameWidth = nameWidth;
						}
						var keyWidth = ctx.measureText(RegExp.$2).width;
						if (entity.keyWidth == undefined) {
							entity.keyWidth = keyWidth;
						} else if (entity.keyWidth < keyWidth) {
							entity.keyWidth = keyWidth;
						}
						var typeWidth = ctx.measureText(RegExp.$3).width;
						if (entity.typeWidth == undefined) {
							entity.typeWidth = typeWidth;
						} else if (entity.typeWidth < typeWidth) {
							entity.typeWidth = typeWidth;
						}
						fields.unshift(field);
					} else if (txtArr[line].match(/^PName=(.+)/)) {
						entity.key = RegExp.$1;
						var nameWidth = ctx.measureText(RegExp.$1).width;
						if (entity.nameWidth == undefined) {
							entity.nameWidth = nameWidth;
						} else if (entity.nameWidth < nameWidth) {
							entity.nameWidth = nameWidth;
						}
					} else if (txtArr[line].match(/^LName=(.+)/)) {
						entity.name = RegExp.$1;
						var keyWidth = ctx.measureText(RegExp.$1).width;
						if (entity.keyWidth == undefined) {
							entity.keyWidth = keyWidth;
						} else if (entity.keyWidth < keyWidth) {
							entity.keyWidth = keyWidth;
						}
					} else if (txtArr[line].match(/^Entity1=(.+)/)) {
						relation.entity1 = RegExp.$1;
					} else if (txtArr[line].match(/^Entity2=(.+)/)) {
						relation.entity2 = RegExp.$1;
					} else if (txtArr[line].match(/^Bar1=(\d+)/)) {
						relation.x = RegExp.$1;
					} else if (txtArr[line].match(/^Bar2=(\d+)/)) {
						relation.y = RegExp.$1;
					} else if (txtArr[line].match(/^Bar3=(\d+)/)) {
						relation.z = RegExp.$1;
					} else if (txtArr[line].match(/^Left=(\d+)/)) {
						entity.x = RegExp.$1;
					} else if (txtArr[line].match(/^Top=(\d+)/)) {
						entity.y = RegExp.$1;
					} else if (txtArr[line].match(/^FontSize=(\d+)/)) {
						xRate = RegExp.$1 / 3;
						yRate = RegExp.$1 / 4;
					} else if (txtArr[line] == "[Entity]") {
						entity.fields = fields;
						entities.unshift(entity);
						entity = new Array();
						fields = new Array();
						relation = new Array();
					} else if (txtArr[line] == "[Relation]") {
						relations.unshift(relation);
						entity = new Array();
						fields = new Array();
						relation = new Array();
					}
				}

				var selectPage = document.form_a5er.page;
				selectPage.options = new Array();
				for (var page in pages) {
					selectPage.options[page] = new Option(pages[page]);
				}

				scrollX = 0;
				scrollY = 0;

				drawER();

			}
			reader.readAsText(myFile, 'utf-8');
		}

		function erMouseDown(e) {
			origX = scrollX - e.offsetX;
			origY = scrollY - e.offsetY;
			dragging = true;
		}

		function erMouseUp(e) {
			dragging = false;
		}

		function erMouseOut(e) {
			dragging = false;
		}

		function erMouseMove(e) {
			if (dragging) {
				scrollX = origX + e.offsetX;
				scrollY = origY + e.offsetY;
				drawER();
			}
		}

</script>

</head>

<body>
	<form name='form_a5er'>
		<input id='input_a5er' type='file' />
		<input type="button" value="Draw" onClick="loadER()">
		<br />
		<label for="page">Page: </label>
		<select id="page" onchange="drawER()">
			<option value="0" selected="selected">MAIN</option>
		</select>
		&nbsp;&nbsp;
		<label for="view_level">View Level: </label>
		<select id="view_level" onchange="drawER()">
			<option value="0">Attributes Only</a>
				<option value="1">Attributes & Pyhsical Names</a>
					<option value="2">Attributes & Types</a>
					</select>
				</form>
				<hr />
				<canvas id='canvas_er' width='2048px' height='2048px' style='border:1px; border-color:gray;'>

				</canvas>

			</body>

			</html>